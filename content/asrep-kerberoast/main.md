# asrep roasting and kerberoasting

## tl;dr
- Both **AS-REP roasting** and **Kerberoasting** are techniques used to steal NTLM hashes that can be cracked offline.
- However, the techniques differ in the part of the Kerberos protocol abused.
- **AS-REP roasting** allows the NTLM hashes of user accounts who _do not use pre-authentication_ (refered to as `USERS_NO_PREAUTH` in this article) to be stolen.
  - This occurs as a misconfiguration in Kerberos: `Do not require Kerberos pre-authentication`.
  - The attack is called "AS-REP Roasting" because `AS_REP` is the name of the _response_ (`REP`) sent from the Kerberos Authentication Service (`AS`). From this `AS_REP` response, attackers can steal the NTLM hashes of `USERS_NO_PREAUTH`.

## kerberos basics

- relies on _symmetric key cryptography_

### the players

#### the client

#### the Key Distribution Center (KDC)
- The KDC plays the main role in Kerberos authentication.
- Contains
  - a database of users and application hashes
  - an authentication server
  - a ticket granting service (TGS)

#### the application/service server (SS)

## terminology reference

- **Ticket Granting Service (TGS)**. A **ticket** (not a service) that a user can use to authenticate against a service
  - The **TGS** is encrypted with the **Service Key**.
- **Service Principal Name (SPN)**. A SPN is used to uniquely identify a service that uses Kerberos authentication.
  - Linked to every service (and thus SPN) is a **user account** whose NTLM hash is used to encrypt the **service tickets** granted by the **TGS**.
    - If the **user account** is auto-generated by Active Directory, then the password is auto-generated and uncrackable (128 characters long).
    - If the **user account** belongs to a **domain user**, then there is a possibility we can obtain the **domain user**'s password via **kerberoasting** and **password cracking**.

## kerberoasting

### what is kerberoasting?
- Kerberoasting is a technique for gathering credential hashes (that can be cracked offline), often for more privileged accounts.


### how it works
- There are two main ideas behind Kerberoasting:
  - **Service tickets** are encrypted using a domain user's NTLM hash.
  - The **TGS** in the **KDC** does not verify whether or not a user is authorized to access a service (authorization is the service's responsibility); thus, the **TGS** will grant a **service ticket** to any user who requests one. _This means that the NTLM hash for a domain account is (indirectly) leaked by the TGS_.
    - If the **domain user** has a weak password, then we can try common passwords, generate their NTLM hashes, and then see if decryption succeeds. If it does, then we have cracked the **domain user**'s password.


## asrep roast

## references

- [A deep dive into the Kerberoast attack.](https://www.hackingarticles.in/deep-dive-into-kerberoasting-attack/)
- [Kerberoasting: stealing service account credentials](https://www.scip.ch/en/?labs.20181011)
